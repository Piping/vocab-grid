# Vocab Grid 设计文档

## 项目概述
Vocab Grid 是一个词汇学习应用，旨在帮助用户更高效地学习和记忆单词。应用提供单词展示、释义查看、发音播放以及单词标记功能，并通过分页和滚动设计提升用户体验。

## 功能需求
1. **全屏显示**：应用应占据整个屏幕空间，提供沉浸式学习体验。
2. **单词展示**：以网格布局展示单词卡片，每张卡片包含单词、释义和发音信息。
3. **分页功能**：单词列表支持分页显示，每页展示固定数量的单词。
4. **滚动显示**：当单词数量超过容器高度时，支持垂直滚动查看。
5. **单词标记**：用户可以点击单词卡片标记或取消标记已记住的单词。
6. **响应式设计**：适应不同屏幕尺寸，确保在各种设备上都有良好的显示效果。

## UI设计
1. **整体布局**：
   - 头部：显示应用名称和使用说明。
   - 主体：单词网格布局，支持分页和滚动。
   - 底部：分页控件，允许用户切换页面。
2. **单词卡片**：
   - 卡片：显示单词和已记住标记。
   - 悬浮Tooltip：鼠标悬停时在卡片上方显示释义和发音按钮, 并且播放单词发音。
3. **分页控件**：
   - 包含页码按钮，当前页码高亮显示。
   - 支持点击切换页面。

## 技术实现
1. **前端框架**：使用 React 构建用户界面。
2. **状态管理**：使用 React useState 管理分页状态和单词数据。
3. **数据存储**：使用 IndexedDB 本地存储单词数据。
4. **样式实现**：
   - 使用自定义css + classname 实现
   - 使用 flex 和 grid 布局实现响应式设计。
5. **分页逻辑**：
   - 定义每页显示的单词数量。
   - 计算总页数和当前页显示的单词范围。
   - 实现页码切换功能。

## 用户需求变更记录
1. **翻页自动发音**：实现翻页后自动为第一个单词发音的功能。
2. **鼠标位置跟踪发音**：翻页时根据鼠标位置确定发音单词，即鼠标指向哪个单词就播放哪个单词的发音。
3. **按键翻页发音修复**：修复按键翻页后发音功能不工作的问题。
4. **多次翻页发音修复**：修复第二次翻页发音失效的问题。
5. **悬停发音优化**：只播放鼠标悬停的单词发音，即仅当鼠标指向某个单词时才播放该单词发音。

## 未来优化方向
1. **语音合成**：集成 Web Speech API，实现单词发音功能。
2. **单词筛选**：添加按首字母、难度等筛选单词的功能。
3. **学习进度统计**：添加学习进度统计和可视化功能。
4. **主题切换**：支持浅色/深色主题切换。

## 已知问题与解决方案

## 单词播音功能设计方案

## 功能概述
- 翻页自动发音：切换页面时自动播放当前页第一个单词
- 悬停发音：鼠标悬停在单词上时播放发音，并支持定时重复播放

## 实现细节要点
1. **状态管理**
   - 使用`shouldPlayPronunciation`状态控制翻页发音触发
   - 通过`hoveredWordId`跟踪悬停单词状态
   - 使用`lastSpokenWordRef`记录最后发音单词，避免重复取消

2. **React生命周期处理**
   - 使用`useLayoutEffect`确保DOM更新后执行发音逻辑
   - 分离翻页发音和悬停发音两个独立effect
   - 添加定时器清理函数防止内存泄漏

3. **发音控制逻辑**
   - 翻页时取消所有进行中的语音任务
   - 仅在单词变化时取消之前的发音任务
   - 使用100ms延迟确保状态更新完成

4. **错误处理**
   - 添加try-catch块捕获发音错误
   - 记录详细日志便于调试
   - 处理浏览器语音API限制

## 问题及解决方案
1. **状态异步更新问题**
   - 原因：React状态更新异步导致currentWords未及时更新
   - 解决方案：使用ref跟踪最新数据，确保发音时使用最新单词

2. **竞态条件问题**
   - 原因：快速翻页时定时器未清理导致发音混乱
   - 解决方案：保存定时器ID，在翻页时清除所有未执行的定时器

3. **浏览器API限制**
   - 原因：浏览器限制非用户交互触发的语音合成
   - 解决方案：将语音调用包装在setTimeout中，绑定到用户点击事件

4. **语法错误**
   - 原因：依赖数组缺少逗号，export语句多余分号
   - 解决方案：修复语法错误，添加必要的导入

5. **未定义引用**
   - 原因：lastSpokenWordRef未初始化
   - 解决方案：添加useRef导入并初始化引用